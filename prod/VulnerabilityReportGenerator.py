import joblib
import numpy as np
from typing import List, Dict, Any
from prod.StaticAnalyzer import StaticAnalyzer, generate_feature_vector
from prod.CodeReader import CodeReader

class VulnerabilityReportGenerator:
    def __init__(self, model_path: str, scaler_path: str):
        """
        Initialize the report generator by loading a pre-trained model and scaler.
        """
        self.model = joblib.load(model_path)
        self.scaler = joblib.load(scaler_path)
        self.reader = CodeReader(extensions=[".py"])

    def analyze_path(self, target_path: str) -> List[Dict[str, Any]]:
        """
        Analyze all .py files under the target path and produce structured reports.

        :param target_path: Path to a single Python file or directory.
        :return: List of structured vulnerability reports.
        """
        files = self.reader.read_files(target_path)
        all_reports = []

        for file_path, code in files:
            analyzer = StaticAnalyzer()
            vulnerabilities = analyzer.analyze(code)
            feature_vector = generate_feature_vector(vulnerabilities)

            # Predict severity/confidence
            X = np.array([list(feature_vector.values())])
            X_scaled = self.scaler.transform(X)
            prediction = self.model.predict(X_scaled)[0]
            confidence = round(float(max(self.model.predict_proba(X_scaled)[0])), 2)
            severity = ["Low", "Medium", "High"][prediction]

            # Create a report entry for each vulnerability
            for vuln in vulnerabilities:
                all_reports.append({
                    "file": file_path,
                    "line": vuln.get("line", "?"),
                    "issue": vuln.get("type", "Unknown issue"),
                    "severity": severity,
                    "confidence": confidence,
                    "code_snippet": "(context not available)",
                    "suggested_fix": self._suggest_fix(vuln.get("type", ""))
                })

        return all_reports

    def _suggest_fix(self, issue_type: str) -> str:
        """
        Suggest a remediation based on the type of vulnerability.
        """
        suggestions = {
            "Dangerous Dynamic SQL Query": "Use parameterized queries instead of string concatenation.",
            "Generally Dangerous Function Call": "Avoid eval/exec; use safer alternatives.",
            "Tainted File Access (open)": "Validate file paths to avoid path traversal.",
            "Unsafe Deserialization": "Avoid pickle; use safe formats like JSON.",
            "Use of Uninitialized Variable": "Initialize variables before use.",
        }
        return suggestions.get(issue_type, "Review the code and apply standard security practices.")
